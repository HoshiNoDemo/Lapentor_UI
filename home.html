<!-- 
Notas:
    Para que este c처digo resulte, os plugins obrigat처rios no Lapentor s찾o:
        ->Floorplan
        ->Default UI plugins
        ->Scene title
        ->Floorplan
        ->Custom code, obviamente.
    
    Faz copy paste do c처digo abaixo para o Custom Code HTML.
-->


<!--<input class="Overlayed" id="myelement" type="button" value="PRESS ME" onmousedown="hideUI()">-->
<div id="my-view-list" class="Overlayed">Overlay JSDemoC v0.21</div>

<script>


    //Setup
    var marker_list = []
    var current_view = ""

    // set up the mutation observer
    var observer = new MutationObserver(function (mutations, me) {
        // `mutations` is an array of mutations that occurred
        // `me` is the MutationObserver instance
        var floorplan = document.getElementById('PluginFloorplan');
        if (floorplan) {

            marker_list = [].slice.call(document.getElementsByClassName("thumb ng-binding ng-scope"))
            current_view = document.getElementById("PluginScenetitle").innerText
            init()

            me.disconnect(); // stop observing
            return;
        }
    });

    // start observing
    observer.observe(document, {
    childList: true,
    subtree: true
    });



    
    function init(){


        //Setup a onmouseup listener to check for room and floor changes
        document.addEventListener("mouseup", function(){
            console.log("Initting.")

            //Check if current markers were changed
            setTimeout(function(){
                    var new_marker_list = [].slice.call(document.getElementsByClassName("map-placemarker thumb ng-scope"))

                    var new_current_view = document.getElementById("PluginScenetitle").innerText

                    if (current_view !== new_current_view){
                        console.log("We've changed scenes!")

                        /*
                            TODO check if the canvas FOV is gone, this means we've changed floors!
                                If canvas is clear: We've moved floors. Iterate through the floors to check if the canvas FOV is now there!
                                If canvas is occupied: Do nothing.
                        */
                        if (isCanvasClear(document.getElementById("canvas-map"))){
                            console.log("CHANGED FLOOR!")
                        }
                    }
                    
                    current_view = new_current_view
                    marker_list = new_marker_list

                },1000)
        })

    }

    function isCanvasClear(canvas){
        return !canvas.getContext('2d')
            .getImageData(0, 0, canvas.width, canvas.height).data
            .some(channel => channel !== 0);
    }

    function htmlEquals(a1, a2) {
        if(a1.length !== a2.length)
            return false;
        for(var i = a1.length; i--;) {
            if(a1[i].innerHTML !== a2[i].innerHTML)
                return false;
        }
        return true;
    }

    /**
    * Hides the top right scene selection.
    */
    function hideUI() {
        var x = document.getElementById('scenelist-ghost')
        
        if (x.style.display === "none"){
            x.style.display = "block"
        } else {
            x.style.display = "none"
        }
    }


    /**
    * Resets the view to the initial floor and initial view.
    * The order of which you insert the floors and views in the plugin matter!
    */
    function returnToStart() {
        var x = document.getElementById("PluginFloorplan")
        var y = x.getElementsByClassName("list")    
        var z = y[0].children[0]
    
        z.click()

        //After 100ms do this.
        setTimeout(function(){
            var x = document.getElementById("PluginFloorplan")
            var y = document.getElementById("map-floorplan")
            var z = document.getElementsByClassName("map-placemarker thumb ng-scope")
            z[0].click()
        },100)
    }
</script>    